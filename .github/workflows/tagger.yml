name: Tagger

on:
    workflow_run:
        workflows: [ "Compiler" ]
        types:
            - completed
        branches:
            - master
        tags-ignore:
            - 'v*'

jobs:
    tagger:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@master
                with:
                    fetch-depth: 0

            -   name: Get previous tag
                id: previousTag
                run: |
                    name=$(git --no-pager tag --sort=creatordate --merged ${{ github.ref_name }} | tail -2 | head -1)
                    echo "previousTag: $name"
                    echo "previousTag=$name" >> $GITHUB_ENV

            -   name: Increment version
                id: increment
                run: |
                    previousTag=$previousTag
                    IFS='.' read -r -a array <<< "$previousTag"
                    major=${array[0]}
                    minor=${array[1]}
                    patch=${array[2]}
                    if [ $patch -eq 99 ]; then
                      patch=0
                      if [ $minor -eq 99 ]; then
                        minor=0
                        major=$((major+1))
                      else
                        minor=$((minor+1))
                      fi
                    else
                      patch=$((patch+1))
                    fi
                    newTag="v$major.$minor.$patch"
                    echo "newTag: $newTag"
                    echo "newTag=$newTag" >> $GITHUB_ENV

            -   name: Create Tag
                run: |
                    git config --local user.email "costa@elton.schivei.nom.br" \
                      && git config --local user.name "Elton Schivei Costa" \
                      && git tag $newTag ${{ github.sha }} -a -m "Tag $newTag" \
                      && git push origin $newTag
